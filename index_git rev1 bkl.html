<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Moai Robo â€” Yogurt Run EX (Final Edition)</title>
<style>
:root{--bg:#0b1020;--fg:#e6f0ff;--ui:#111827}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif}
#wrap{display:flex;flex-direction:column;height:100%}
#game{flex:1 1 auto;display:flex;align-items:center;justify-content:center;position:relative;}
canvas{width:100vw;height:100vh;image-rendering:pixelated;touch-action:none;background:#000}
#hud{position:fixed;top:8px;left:8px;background:#0008;padding:4px 8px;border-radius:8px;font:12px monospace;z-index:3}
#ctrls{position:fixed;bottom:14px;left:0;right:0;display:flex;justify-content:space-between;padding:0 16px;gap:12px;z-index:2}
.btn{flex:1;background:var(--ui);color:var(--fg);border:1px solid #374151;border-radius:14px;padding:10px 8px;text-align:center;font-weight:700;user-select:none}
.btn:active{background:#374151;}
#start,#over{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;background:#0b1020;z-index:4}
#over{display:none}
#title{font:22px/1.2 monospace;letter-spacing:.5px;opacity:.95;text-align:center;margin-bottom:4px}
.small{font:12px monospace;opacity:.8;text-align:center}
#overTitle{font:20px monospace;margin-bottom:4px}
#mute{position:fixed;top:8px;right:8px;z-index:3;
Â  background:#111827;color:#e6f0ff;border:1px solid #374151;
Â  border-radius:12px;padding:6px 10px;font:12px/1 system-ui,monospace}
</style>
</head>
<body>
<div id="wrap">
Â  <div id="game">
Â  Â  <canvas id="cv" width="360" height="200"></canvas>
Â  </div>

Â  <div id="hud">
Â  Â  S:<span id="sc">0</span>
Â  Â  &nbsp;L:<span id="lf">3</span>
Â  Â  &nbsp;ST:<span id="st">1</span>
Â  Â  &nbsp;T:<span id="tg">200</span>
Â  </div>

Â  <button id="mute" aria-pressed="false" title="Sound">ğŸ”‡ éŸ³OFF</button>

Â  <div id="ctrls">
Â  Â  <div class="btn" id="jump">JUMP</div>
Â  Â  <div class="btn" id="shot">SHOT</div>
Â  Â  <div class="btn" id="drop">DROP</div>
Â  </div>

Â  <div id="start">
Â  Â  <div style="font-size:40px;margin-bottom:10px;">ğŸ—¿</div>
Â  Â  <div id="title">MOAI ROBO â€” YOGURT RUN EX</div>
Â  Â  <div class="small">
Â  Â  Â  Tap/Space/â†‘: Jump | â†“: Drop<br>F/SHOT: Attack (Final Stage)
Â  Â  </div>
Â  Â  <div class="btn" id="go" style="width:120px;margin-top:10px;">GAME START</div>
Â  </div>

Â  <div id="over">
Â  Â  <div id="overTitle">GAME OVER</div>
Â  Â  <div id="scoreline" class="small"></div>
Â  Â  <div class="btn" id="retry" style="width:120px;">RETRY</div>
Â  </div>
</div>

<script>
(()=>{
// ====================================
//Â  CONSTANTS & CONFIG
// ====================================
const G = { W:360, H:200, GROUND:200-24 };
const MAX_LIVES = 10;

// ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š
const STAGES = [
Â  // STAGE 1: æœãƒ»å‡ºç¤¾ (ãƒ†ãƒ¼ãƒ: é¿ã‘ã‚‰ã‚Œãªã„å‡ºç¤¾ => Companyç‡ãŒé«˜ã„)
Â  { id:1, name:'MORNING', theme:'é¿ã‘ã‚‰ã‚Œãªã„å‡ºç¤¾', target: 300, speed:1.6, obsRate:1.2, insectRate:0.3, taxRate: 0.0, companyRate:0.7, meetingRate:0.0, celeryRate:0.0, anxietyRate:0.0, workRate:0.0, workSpawnMin: 0, workSpawnMax: 0 },Â 
Â  // STAGE 2: æ˜¼ãƒ»æ˜¼é£Ÿ (ãƒ†ãƒ¼ãƒ: ä»•äº‹ã¯å¤šãã§ã‚‚æ™‚é–“ã‚‚é€²ã¾ãªã„ã€‚)
Â  { id:2, name:'NOON',Â  theme:'æ™‚ã®æµã‚Œã¯é…ã„', target:Â  600, speed:1.9, obsRate:1.3, insectRate:0.3, taxRate: 0.0, companyRate:0.0, meetingRate:0.2, celeryRate:0.3, anxietyRate:0.0, workRate:0.5, workSpawnMin: 120, workSpawnMax: 300 },Â 
Â  // STAGE 3: å¤œ (ãƒ†ãƒ¼ãƒ: çµ‚ã‚ã‚‰ãªã„ä¸€æ—¥ => Meetingã¨WorkãŒãƒ¡ã‚¤ãƒ³)
Â  { id:3, name:'NIGHT',Â  theme:'çµ‚ã‚ã‚‰ãªã„ä¸€æ—¥', target: 900, speed:2.2, obsRate:1.4, insectRate:0.3, taxRate: 0.0, companyRate:0.0, meetingRate:0.4, celeryRate:0.0, anxietyRate:0.0, workRate:0.7, workSpawnMin: 90, workSpawnMax: 200 },Â 
Â  // STAGE 4: äººç”Ÿãƒ»å†…é¢ (ãƒ†ãƒ¼ãƒ: ä¸å®‰ã¨æ„Ÿæƒ… => Tax, AnxietyãŒãƒ¡ã‚¤ãƒ³)
Â  { id:4, name:'INNER',Â  theme:'ä¸å®‰ã¨æ„Ÿæƒ…', target: 1200, speed:2.8, obsRate:1.5, insectRate:0.25, taxRate: 0.3, companyRate:0.0, meetingRate:0.0, celeryRate:0.0, anxietyRate:0.3, workRate:0.5, workSpawnMin: 180, workSpawnMax: 350 },Â 
Â  // STAGE 5: BOSS
Â  { id:5, name:'BOSS',Â  theme:'æ±ºæˆ¦', target: Infinity, speed:2.4, obsRate:0.0, insectRate:0.0, taxRate: 0.0, companyRate:0.0, meetingRate:0.0, celeryRate:0.0, anxietyRate:0.0, workRate:0.0, workSpawnMin: 0, workSpawnMax: 0, boss:true }
];
// ====================================
//  SOUND ENGINE (ã“ã“ã‚’è¿½åŠ )
// ====================================
const BGM_FREQS = [ 
    130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00,
    207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66, 311.13,
    329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88,
    523.25, 554.37, 587.33, 622.25, 659.25
];

const STAGE_BGM_DATA = [
    { melody: [12,19,16,19,12,19,16,21,14,21,17,21,14,21,17,24], base: [0, 0, 5, 5, 7, 7, 0, 0], wave: 'square', tempo: 140, decay: 0.1 },
    { melody: [16,-1,19,-1,17,-1,16,-1,12,-1,14,-1,11,-1,-1,-1], base: [4, 4, 5, 5, 0, 0, 7, 7], wave: 'triangle', tempo: 90, decay: 0.4 },
    { melody: [12,12,24,-1,23,21,19,-1,17,17,15,14,12,-1,12,-1], base: [0, 3, 5, 7, 0, 3, 5, 10], wave: 'sawtooth', tempo: 120, decay: 0.2 },
    { melody: [12,13,15,16,12,13,15,16,19,18,16,15,13,12,11,10], base: [0, 1, 3, 4, 0, 1, 3, 4], wave: 'sawtooth', tempo: 110, decay: 0.3, detune: true },
    { melody: [12,24,12,24,15,27,15,27,17,29,17,29,19,31,19,31], base: [0,0,0,0,5,5,7,7,8,8,10,10,12,12,15,15], wave: 'square', tempo: 170, decay: 0.15, drum: true }
];

let bgmTimer = null;
let bgmNoteIndex = 0;

function playBgmNote(freq, type, vol, decay, detuneValue = 0) {
    if (muted || freq <= 0) return;
    try {
        const c = audioCtx();
        const now = c.currentTime;
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, now);
        if(detuneValue) o.detune.setValueAtTime(detuneValue, now);
        o.connect(g); g.connect(c.destination);
        g.gain.setValueAtTime(vol, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + decay);
        o.start(now); o.stop(now + decay);
    } catch(e) {}
}

function playBgmNoise(vol, decay) {
    if (muted) return;
    try {
        const c = audioCtx();
        const now = c.currentTime;
        const bufferSize = c.sampleRate * decay;
        const buffer = c.createBuffer(1, bufferSize, c.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const source = c.createBufferSource();
        source.buffer = buffer;
        const g = c.createGain();
        g.gain.setValueAtTime(vol, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + decay);
        source.connect(g); g.connect(c.destination);
        source.start(now); source.stop(now + decay);
    } catch(e) {}
}

function updateBgmSequencer() {
    const isBgmState = ['PLAY', 'TITLE', 'CLEAR', 'TRANSITION'].includes(state);
    if (!isBgmState) { stopBgm(); return; }

    const d = STAGE_BGM_DATA[stageIndex];
    if (!d) return;

    const stepSec = 60 / d.tempo / 4;
    const m = d.melody[bgmNoteIndex];
    if (m !== -1 && m !== undefined) {
        let det = d.detune ? Math.sin(Date.now() * 0.01) * 50 : 0;
        playBgmNote(BGM_FREQS[m], d.wave, 0.06, d.decay, det);
    }
    if (bgmNoteIndex % 2 === 0) {
        const b = d.base[(bgmNoteIndex / 2) % d.base.length];
        if (b !== -1) playBgmNote(BGM_FREQS[b], 'triangle', 0.1, stepSec * 2);
    }
    if (d.drum && bgmNoteIndex % 4 === 0) playBgmNoise(0.04, 0.05);

    bgmNoteIndex = (bgmNoteIndex + 1) % d.melody.length;
    bgmTimer = setTimeout(updateBgmSequencer, stepSec * 1000);
}

function stopBgm() {
    clearTimeout(bgmTimer);
    bgmTimer = null;
    bgmNoteIndex = 0;
}
// ãƒœã‚¹æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
const BOSS_ATTACKS = ['MoaiThrow_Arc', 'MoaiThrow_Horizontal', 'MoaiThrow_Homing'];

// ====================================
//Â  CANVAS SETUP (çœç•¥)
// ====================================
const cvÂ  = document.getElementById('cv');
const ctx = cv.getContext('2d');

function fitCanvas(){
Â  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
Â  const scale = Math.floor(Math.min(innerWidth/G.W, innerHeight/G.H) * dpr);
Â  cv.widthÂ  = G.W * scale;
Â  cv.height = G.H * scale;
Â  cv.style.widthÂ  = (G.W * scale / dpr) + 'px';
Â  cv.style.height = (G.H * scale / dpr) + 'px';
Â  ctx.setTransform(scale, 0, 0, scale, 0, 0);
Â  ctx.imageSmoothingEnabled = false;
}
fitCanvas();
addEventListener('resize', fitCanvas);

// ====================================
//Â  IMAGE LOADING
// ====================================
const moaiImage = new Image();
moaiImage.src = 'moai_robo.png';
let moaiImageLoaded = false;
moaiImage.onload = () => { moaiImageLoaded = true; };
moaiImage.onerror = () => { console.error("Error loading moai_robo.png. Check file path."); };

const authorImg0 = new Image(); authorImg0.src = 'boss_author.png'; // é€šå¸¸
const authorImg1 = new Image(); authorImg1.src = 'boss_author_charge.png'; // ã‚¿ãƒ¡ï¼ˆã‚¹ãƒ­ãƒ¼ä¸­ï¼‰
const authorImg2 = new Image(); authorImg2.src = 'boss_author_attack.png'; // ç™ºå°„ï¼ˆã‚¹ãƒ­ãƒ¼å¾Œï¼‰

let authorImageLoaded = false;
let authorImageCount = 0;
function markAuthorImageLoaded(){
  authorImageCount++;
  if(authorImageCount >= 3) authorImageLoaded = true;
}
authorImg0.onload = markAuthorImageLoaded;
authorImg1.onload = markAuthorImageLoaded;
authorImg2.onload = markAuthorImageLoaded;
authorImg0.onerror = () => { console.error("Error loading boss_author.png. Check file path."); };
authorImg1.onerror = () => { console.error("Error loading boss_author_charge.png. Check file path."); };
authorImg2.onerror = () => { console.error("Error loading boss_author_attack.png. Check file path."); };

const moaiShotImage = new Image();
moaiShotImage.src = 'moai_shot.png';
let moaiShotImageLoaded = false;
moaiShotImage.onload = () => { moaiShotImageLoaded = true; };
moaiShotImage.onerror = () => { console.error("Error loading moai_shot.png. Check file path."); };

const slimeImage = new Image();
slimeImage.src = 'enemy_slime.png';
let slimeImageLoaded = false;
slimeImage.onload = () => { slimeImageLoaded = true; };

const insectImage = new Image();
insectImage.src = 'enemy_insect.png';Â 
let insectImageLoaded = false;
insectImage.onload = () => { insectImageLoaded = true; };

const companyImage = new Image();
companyImage.src = 'obstacle_company.png';
let companyImageLoaded = false;
companyImage.onload = () => { companyImageLoaded = true; };

const meetingImage = new Image();
meetingImage.src = 'obstacle_meeting.png';
let meetingImageLoaded = false;
meetingImage.onload = () => { meetingImageLoaded = true; };

const celeryImage = new Image();
celeryImage.src = 'obstacle_celery.png';
let celeryImageLoaded = false;
celeryImage.onload = () => { celeryImageLoaded = true; };

const anxietyImage = new Image();
anxietyImage.src = 'obstacle_anxiety.png';
let anxietyImageLoaded = false;
anxietyImage.onload = () => { anxietyImageLoaded = true; };

const workImage = new Image();
workImage.src = 'obstacle_work.png';
let workImageLoaded = false;
workImage.onload = () => { workImageLoaded = true; };
workImage.onerror = () => { console.warn("Warning: obstacle_work.png not loaded."); };


// ====================================
//Â  AUDIO SYSTEM (çœç•¥)
// ====================================
let AC = null;
let audioUnlocked = false;
let muted = false;

function audioCtx(){
Â  if(!AC) AC = new (window.AudioContext || window.webkitAudioContext)();
Â  return AC;
}

['touchstart','mousedown','keydown'].forEach(ev=>{
Â  addEventListener(ev, async ()=>{
Â  Â  try{
Â  Â  Â  const c = audioCtx();
Â  Â  Â  if(c.state === 'suspended') await c.resume();
Â  Â  Â  audioUnlocked = true;
Â  Â  }catch(e){}
Â  }, {passive:true});
});

function beep(freq=440, dur=0.07, type='square', vol=0.18){
Â  if(muted) return;
Â  try{
Â  Â  const c = audioCtx();
Â  Â  const now = c.currentTime;
Â  Â  const o = c.createOscillator();
Â  Â  const g = c.createGain();
Â  Â  o.type = type;
Â  Â  o.frequency.setValueAtTime(freq, now);
Â  Â  o.connect(g); g.connect(c.destination);
Â  Â  g.gain.setValueAtTime(0.0001, now);
Â  Â  g.gain.exponentialRampToValueAtTime(vol, now+0.005);
Â  Â  g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
Â  Â  o.start(now);
Â  Â  o.stop(now+dur+0.05);
Â  }catch(e){}
}

function playFanfare(){
Â  Â  if(muted) return;
Â  Â  beep(784, 0.1, 'sine', 0.2);
Â  Â  setTimeout(()=>beep(988, 0.15, 'sine', 0.25), 100);
Â  Â  setTimeout(()=>beep(1319, 0.3, 'sine', 0.3), 300);
}

const muteBtn = document.getElementById('mute');
function updateMuteUI(){
  // --- æ—¢å­˜ã®å‡¦ç† ---
  muteBtn.textContent = muted ? 'ğŸ”‡ éŸ³OFF' : 'ğŸ”Š éŸ³ON';
  muteBtn.setAttribute('aria-pressed', String(!muted));

  // --- â˜…ã“ã“ã‹ã‚‰ BGMé€£å‹•ã‚’è¿½è¨˜ ---
  if (muted) {
    // ãƒŸãƒ¥ãƒ¼ãƒˆã«ã—ãŸã‚‰BGMã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
    if (bgmTimer) {
      clearTimeout(bgmTimer);
      bgmTimer = null;
    }
  } else {
    // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ã—ãŸæ™‚ã€ã‚²ãƒ¼ãƒ ä¸­ãªã‚‰BGMã‚’å†é–‹ã™ã‚‹
    const isPlaying = ['PLAY', 'TITLE', 'CLEAR', 'TRANSITION'].includes(state);
    if (!bgmTimer && isPlaying) {
      updateBgmSequencer();
    }
  }
}
muteBtn.addEventListener('click', ()=>{
Â  muted = !muted;
Â  updateMuteUI();
Â  if(!muted) beep(660,0.06,'square',0.2);
});


// ====================================
//Â  GAME STATE (çŠ¶æ…‹ã¨å¤‰æ•°)
// ====================================
let state = 'START'; // START, PLAY, CLEAR, TRANSITION, TITLE, ENDING, OVER
let score = 0;
let best = 0;
let lives = 10;
let t = 0;

let stageIndex = 0;
let currentStage = STAGES[0];
let nextStageIndex = 0; // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”¨

const player = { x:80, y:G.GROUND, vy:0, onG:true, bg:0, speed:0, bob:0 };
const items = [];
const obstacles = [];
let itemSpawn = 30;
let obstacleSpawn = 60;
let workSpawn = 0;Â 

// BossÂ 
const BOSS_MAX_HP = 100;
const boss = {
  active:false, x:G.W-60, y:G.GROUND-40, hp:BOSS_MAX_HP, timer:0, dir:1,
  attackIndex:0, attackTimer:360,
  isCharging:false, beamWidth:0, frame:0
};
const bossShots = [];Â 
const bulletsÂ  Â = [];Â 

// Ending (çœç•¥)
let endScrollY = 0;
// â˜… CREDITSã«ç§˜å¯†ã®ã‚³ãƒ¼ãƒ‰ã®æ¼”å‡ºè¡Œã‚’è¿½åŠ 
const CREDITS = [
Â  "CONGRATULATIONS!", "",
Â  "MOAI ROBO - YOGURT RUN EX", "",
Â  "--- CAST ---",
Â  "Hero: MOAI ROBO",
Â  "Villain: THE AUTHOR",
Â  "Items: YOGURT, STRAWBERRY MILK", "",
Â  "--- SPECIAL THANKS ---",
Â  "Kanazawa Moai Project",
Â  "AND YOU!", "",
Â  "--- ç§˜å¯†ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ ---", // 12è¡Œç›® (Index 11)
Â  "YOGURTLOVE", // 13è¡Œç›® (Index 12)
Â  "ã“ã‚Œã¯ã€æœªæ¥ã®å†’é™ºã‚’è§£æ”¾ã™ã‚‹éµã§ã™ã€‚", // 14è¡Œç›® (Index 13)
Â  "å¤§åˆ‡ã«ä¿ç®¡ã—ã¦ãã ã•ã„...", // 15è¡Œç›® (Index 14)
Â  "",
Â  "Thank you for playing."
];
const SECRET_CODE_START_INDEX = 11; // åœæ­¢ã‚’é–‹å§‹ã™ã‚‹è¡Œ (--- ç§˜å¯†ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ ---)
const SECRET_CODE_DURATION = 180; // åœæ­¢æ™‚é–“ (3ç§’)

// HUD Elements (çœç•¥)
const scEl = document.getElementById('sc');
const lfEl = document.getElementById('lf');
const stEl = document.getElementById('st');
const tgEl = document.getElementById('tg');
const overEl = document.getElementById('over');
const startEl = document.getElementById('start');

// ====================================
//Â  DRAWING FUNCTIONS
// ====================================
function drawSky(){
Â  let skyHex = '#79bff0'; // Stage 1: MORNING (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
Â  let drawClouds = false;
Â  let drawStars = false;
Â 
Â  // â˜… ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã®èƒŒæ™¯è¨­å®š
Â  if(currentStage.id===2) { skyHex = '#5ac8fa'; } // Stage 2: NOON (é’ç©º)
Â  if(currentStage.id===3) { skyHex = '#0f172a'; drawStars = true; } // Stage 3: NIGHT (å¤œæ™¯)
Â  if(currentStage.id===4) { skyHex = '#1a0b2e'; drawStars = true; } // Stage 4: INNER (ä¸å®‰)
Â  if(currentStage.id===5) { skyHex = '#1a0b2e'; drawStars = true; } // Stage 5: BOSS (ç¶­æŒ)
Â Â 
Â  ctx.fillStyle = skyHex;
Â  ctx.fillRect(0,0,G.W,G.H);

Â  ctx.globalAlpha = 0.1;
Â  ctx.fillStyle = '#fff';
Â  for(let y=0; y<G.H; y+=2){
Â  Â  for(let x=((y>>1)&1)?1:0; x<G.W; x+=2){
Â  Â  Â  ctx.fillRect(x,y,1,1);
Â  Â  }
Â  }
Â  ctx.fillStyle = '#000';
Â  ctx.globalAlpha = 0.05;
Â  for(let y=0; y<G.H; y+=4){
Â  Â  ctx.fillRect(0,y,G.W,1);
Â  }
Â  ctx.globalAlpha = 1;

Â  // Stage 1 & 2: é›²ã®æç”» (æœ/æ˜¼)
Â  if(currentStage.id===1 || currentStage.id===2){
Â  Â  ctx.fillStyle = '#fff';
Â  Â  const cloudSpeed = t * 0.2;
Â  Â  for(let i=0; i<3; i++){
Â  Â  Â  Â  let cx = ((i*120) - cloudSpeed) % (G.W+100);
Â  Â  Â  Â  if(cx < -50) cx += G.W+100;
Â  Â  Â  Â  let cy = 30 + (i*20);
Â  Â  Â  Â  ctx.fillRect(cx, cy, 30, 8);
Â  Â  Â  Â  ctx.fillRect(cx+8, cy-8, 14, 8);
Â  Â  Â  Â  ctx.fillRect(cx+4, cy+8, 20, 4);
Â  Â  }
Â  }

Â  // Stage 3: å¤œæ™¯ï¼ˆå…‰ã‚‹ãƒ“ãƒ«ç¾¤ï¼‰ã®æ¼”å‡º
Â  if(currentStage.id===3){
Â  Â  const buildingColor = '#1e3a8a';
Â  Â  const windowLight = ['#ffcc00', '#fef3c7', '#ffffff'];
Â  Â  const lightSpeed = player.speed * 0.5;

Â  Â  for(let i=0; i<8; i++){
Â  Â  Â  Â  let bw = 20 + (i*5);
Â  Â  Â  Â  let bh = 50 + (i*10);
Â  Â  Â  Â  let bx = ((i*70 + player.bg * lightSpeed * 0.1) % (G.W + 80)) - 40;
Â  Â  Â  Â  if(bx < -bw) bx += G.W + 80;
Â  Â  Â  Â  let by = G.GROUND + 1 - bh;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ãƒ“ãƒ«ã®æœ¬ä½“
Â  Â  Â  Â  ctx.fillStyle = buildingColor;
Â  Â  Â  Â  ctx.fillRect(bx, by, bw, bh);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // çª“ã®æç”»ã¨ç‚¹æ»…æ¼”å‡º
Â  Â  Â  Â  for(let wX = 2; wX < bw - 1; wX += 6){
Â  Â  Â  Â  Â  Â  for(let wY = 4; wY < bh - 4; wY += 6){
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ©ãƒ³ãƒ€ãƒ ãªç‚¹æ»… (t/15ã§å‘¨æœŸã‚’é…ã‚‰ã›ã‚‹)
Â  Â  Â  Â  Â  Â  Â  Â  const flicker = (Math.floor((bx + by + wX + wY) * 0.1 + t/15) % 10) < 5;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (flicker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = windowLight[(wX/6)|0 % windowLight.length];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(bx + wX, by + wY, 4, 4);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#0f172a'; // æ¶ˆç¯
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(bx + wX, by + wY, 4, 4);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  }

Â  // Stage 4: æŠ½è±¡çš„ãªèƒŒæ™¯ï¼ˆä¸å®‰ã¨æ„Ÿæƒ…ï¼‰ã®æ¼”å‡º
Â  if(currentStage.id===4){
Â  Â  ctx.globalAlpha = 0.6;
Â  Â Â 
Â  Â  // ä¸å®‰å®šãªã‚·ã‚§ã‚¤ãƒ—
Â  Â  const shapeSpeed = player.speed * 0.05;
Â  Â  for(let i=0; i<4; i++){
Â  Â  Â  Â  ctx.fillStyle = (i%2 === 0) ? 'rgba(100, 50, 150, 0.5)' : 'rgba(255, 150, 100, 0.4)';
Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const cx = (G.W/2 + Math.sin(t*0.01*i + i) * 100) + (player.bg * shapeSpeed);
Â  Â  Â  Â  const cy = G.H/2 + Math.cos(t*0.02*i + i) * 50;
Â  Â  Â  Â  const radius = 50 + Math.sin(t*0.03 + i*2) * 20;

Â  Â  Â  Â  ctx.arc(cx % (G.W+radius) - radius/2, cy, radius, 0, Math.PI * 2);
Â  Â  Â  Â  ctx.fill();
Â  Â  }
Â  Â  ctx.globalAlpha = 1;
Â  Â Â 
Â  Â  // ä¸å®‰å®šãªãƒã‚¤ã‚ºï¼ˆæ˜Ÿã®ã‚ˆã†ãªç‚¹æ»…ï¼‰
Â  Â  ctx.fillStyle = '#fff';
Â  Â  for(let i=0; i<30; i++){
Â  Â  Â  let sx = ((i*67) - player.bg*0.1) % G.W;
Â  Â  Â  if(sx<0) sx+=G.W;
Â  Â  Â  let sy = (i*93)%100;
Â  Â  Â Â 
Â  Â  Â  // å‘¨æœŸçš„ãªç‚¹æ»…
Â  Â  Â  if(Math.floor((sx + sy) * 0.1 + t/5) % 8 < 4){
Â  Â  Â  Â  ctx.fillRect(sx,sy,1,1);
Â  Â  Â  }
Â  Â  }
Â  }
}

function drawGround(){
Â  // åœ°é¢ã¨åœ°ä¸­è‰²ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦èª¿æ•´
Â  let g1='#2a612a', g2='#72d65c', g3='#60352f'; // Stage 1: MORNINGÂ 
Â Â 
Â  if(currentStage.id===2) { g1='#54784a'; g2='#98c187'; g3='#4d382f'; } // Stage 2: NOONÂ 
Â  if(currentStage.id===3) { g1='#3b82f6'; g2='#bfdbfe'; g3='#1e3a8a'; } // Stage 3: NIGHTÂ 
Â  if(currentStage.id===4) { g1='#6b7280'; g2='#9ca3af'; g3='#374151'; } // Stage 4: INNERÂ 
Â  if(currentStage.id===5) { g1='#374151'; g2='#6b7280'; g3='#111827'; } // Stage 5: BOSSÂ 

Â  for(let x=0; x<G.W; x+=16){
Â  Â  let dx = x - (player.bg % 16);
Â  Â  ctx.fillStyle=g3; ctx.fillRect(dx,G.H-20,16,20);
Â  Â  ctx.fillStyle=g1; ctx.fillRect(dx,G.H-24,16,4);
Â  Â  ctx.fillStyle=g2; ctx.fillRect(dx+((x>>1)&1),G.H-23,2,2);
Â  Â Â 
Â  Â  ctx.fillStyle = 'rgba(0,0,0,0.2)';
Â  Â  ctx.fillRect(dx+4, G.H-12, 2, 2);
Â  Â  ctx.fillRect(dx+10, G.H-6, 2, 2);
Â  }
}

function drawMoai(){
Â  if(!moaiImageLoaded) return;Â 

Â  const x=player.x;
Â  const y=player.y;
Â  const bob = Math.sin(player.bob)*1.5;
Â  const frameWidth = 32;Â 
Â  const frameHeight = 48;Â 
Â Â 
Â  const drawX = x - frameWidth/2;Â 
Â  const drawY = y - frameHeight + bob;

Â  ctx.drawImage(
Â  Â  moaiImage,Â 
Â  Â  0, 0, moaiImage.width, moaiImage.height,Â 
Â  Â  drawX, drawY, frameWidth, frameHeightÂ  Â 
Â  );

Â  if(player.onG){
Â  Â  ctx.fillStyle = '#fff9';
Â  Â  const dustX = drawX + frameWidth/4;
Â  Â  const dustY = y - 4;
Â  Â Â 
Â  Â  ctx.fillRect(dustX - 4, dustY, 4, 2);
Â  Â  ctx.fillRect(dustX - 8, dustY + 2, 2, 2);
Â  }
}

function drawBottle(it){ /* çœç•¥ */
Â  const x=(it.x-9)|0, y=(it.y-26)|0;
Â Â 
Â  const labelColor = it.score === 20 ? '#ec4899' : '#60a5fa';Â 
Â Â 
Â  ctx.fillStyle = '#3b82f6';
Â  ctx.fillRect(x+6, y+4, 6, 2);
Â  ctx.fillStyle = '#f3f4f6';
Â  ctx.fillRect(x+7, y+6, 4, 2);
Â  ctx.fillStyle = '#f3f4f6';
Â  ctx.fillRect(x+4, y+8, 10, 14);
Â  ctx.fillStyle = it.heal ? '#facc15' : labelColor;
Â  ctx.fillRect(x+4, y+12, 10, 4);
Â  ctx.fillStyle = '#fff';
Â  ctx.fillRect(x+11, y+9, 1, 10);
Â Â 
Â  ctx.strokeStyle = '#1e3a8a';
Â  ctx.lineWidth = 1;
Â  ctx.strokeRect(x+4.5, y+8.5, 9, 13);
}

// â˜… MoaiShot (ãƒ¢ã‚¢ã‚¤å¼¾) ã®æç”»
function drawMoaiShot(s){Â 
Â  Â  if(!moaiShotImageLoaded) return;
Â  Â  if(!s.type.startsWith('MoaiThrow')) return;Â 

Â  Â  const x=s.x, y=s.y;
Â  Â  const frameWidth = 16;
Â  Â  const frameHeight = 16;

Â  Â  ctx.save();
Â  Â  ctx.translate(x,y);
Â  Â  ctx.rotate(t*0.2 + (s.type === 'MoaiThrow_Homing' ? Math.atan2(s.vy, s.vx) : 0));Â 
Â  Â Â 
Â  Â  ctx.drawImage(
Â  Â  Â  moaiShotImage,Â 
Â  Â  Â  0, 0, moaiShotImage.width, moaiShotImage.height,Â 
Â  Â  Â  -frameWidth / 2, -frameHeight / 2, frameWidth, frameHeightÂ  Â 
Â  Â  );
Â  Â Â 
Â  Â  ctx.restore();
}

// â˜… æ•µæç”»é–¢æ•°ç¾¤ (çœç•¥)

function drawInsect(d){
Â  Â  if(!insectImageLoaded) return;
Â  Â Â 
Â  Â  const x=(d.x)|0, y=(d.y)|0;
Â  Â  const bob = Math.sin(t*0.5)*2;
Â  Â  const frameWidth = 24;Â 
Â  Â  const frameHeight = 24;Â 

Â  Â  const drawX = x - frameWidth/2;Â 
Â  Â  const drawY = y - frameHeight/2 + bob;Â 

Â  Â  ctx.drawImage(insectImage, 0, 0, insectImage.width, insectImage.height, drawX, drawY, frameWidth, frameHeight);
}

function drawTax(d){
Â  Â  if(!slimeImageLoaded) return;
Â  Â Â 
Â  Â  const x=(d.x)|0, y=(d.y)|0;
Â  Â  const frameWidth = 48;Â 
Â  Â  const frameHeight = 48;Â 

Â  Â  const drawX = x - frameWidth/2;
Â  Â  const drawY = y - frameHeight;Â 

Â  Â  ctx.drawImage(slimeImage, 0, 0, slimeImage.width, slimeImage.height, drawX, drawY, frameWidth, frameHeight);
}

function drawCompany(d){
Â  Â  if(!companyImageLoaded) return;
Â  Â  const frameWidth = 48;
Â  Â  const frameHeight = 24;
Â  Â  const x = (d.x) | 0;
Â  Â  const y = G.GROUND;
Â  Â Â 
Â  Â  ctx.drawImage(companyImage, 0, 0, companyImage.width, companyImage.height, x - frameWidth / 2, y - frameHeight, frameWidth, frameHeight);
}

function drawMeeting(d){
Â  Â  if(!meetingImageLoaded) return;
Â  Â  const frameWidth = 48;
Â  Â  const frameHeight = 32;
Â  Â  const x = (d.x) | 0;
Â  Â  const y = G.GROUND;
Â  Â Â 
Â  Â  ctx.drawImage(meetingImage, 0, 0, meetingImage.width, meetingImage.height, x - frameWidth / 2, y - frameHeight, frameWidth, frameHeight);
}

function drawCelery(d){
Â  Â  if(!celeryImageLoaded) return;
Â  Â  const frameWidth = 32;
Â  Â  const frameHeight = 32;
Â  Â  const x = (d.x) | 0;
Â  Â  const y = G.GROUND;
Â  Â Â 
Â  Â  ctx.drawImage(celeryImage, 0, 0, celeryImage.width, celeryImage.height, x - frameWidth / 2, y - frameHeight, frameWidth, frameHeight);
}

function drawAnxiety(d){
Â  Â  if(!anxietyImageLoaded) return;
Â  Â  const frameWidth = 32;
Â  Â  const frameHeight = 32;
Â  Â  const x = (d.x) | 0;
Â  Â  const y = (d.y) | 0;
Â  Â  const bob = Math.sin(t*0.5)*2;
Â  Â Â 
Â  Â  ctx.drawImage(anxietyImage, 0, 0, anxietyImage.width, anxietyImage.height, x - frameWidth / 2, y - frameHeight / 2 + bob, frameWidth, frameHeight);
}

function drawWork(d){
Â  Â  if(!workImageLoaded) return;
Â  Â  const frameWidth = 48;Â 
Â  Â  const frameHeight = 48;Â 
Â  Â  const x = (d.x) | 0;
Â  Â  const y = (d.y) | 0;
Â  Â Â 
Â  Â  ctx.drawImage(workImage, 0, 0, workImage.width, workImage.height, x - frameWidth / 2, y - frameHeight, frameWidth, frameHeight);
}

function drawBoss(){ /* çœç•¥ */
  if(!boss.active || !authorImageLoaded) return;

  // --- ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¿œã˜ãŸç”»åƒé¸æŠ ---
  let img = authorImg0;
  if (boss.frame === 1) img = authorImg1;
  if (boss.frame === 2) img = authorImg2;
  const x = boss.x;
  const y = boss.y + Math.sin(t*0.05)*4;

  ctx.save();
  ctx.translate(x,y);
Â Â 
Â  const frameWidth = 32;Â 
Â  const frameHeight = 50;Â 
Â  const drawX = -frameWidth/2;
Â  const drawY = -frameHeight/2;Â 

Â    ctx.drawImage(
    img,
    0, 0, img.width, img.height,
    drawX, drawY, frameWidth, frameHeight
  );

  // æ”»æ’ƒå‰ã®ãƒãƒ£ãƒ¼ã‚¸æ¼”å‡º
  if(boss.frame === 1){ // ãƒ•ãƒ¬ãƒ¼ãƒ 1ï¼ˆã‚¿ãƒ¡ï¼‰ã®æ™‚ã ã‘ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å‡ºã™
    ctx.fillStyle = (t%10<5) ? '#ff0000' : '#ffaa00';
    ctx.beginPath();
    ctx.arc(0, 0, 10 + Math.sin(t*0.5)*2, 0, 6.28);
    ctx.fill();
  }

Â  ctx.restore();

Â  const hpRate = Math.max(0,boss.hp)/BOSS_MAX_HP;
Â  const bw = 120;
Â  ctx.fillStyle='#000'; ctx.fillRect(G.W/2-bw/2, 8, bw, 8);
Â  ctx.fillStyle='#dc2626'; ctx.fillRect(G.W/2-bw/2, 8, bw*hpRate, 8);
}

// â˜… ãƒœã‚¹åã‚¿ã‚°ã®æç”»é–¢æ•°
function drawBossNameTag(){
Â  Â  if (!boss.active) return;
Â  Â  const x = boss.x;
Â  Â  const y = boss.y + Math.sin(t * 0.05) * 4;
Â  Â Â 
Â  Â  const name = 'ä½œè€…'; // â˜… ã‚­ãƒ£ãƒ©åã‚’ã€Œä½œè€…ã€ã«è¨­å®š
Â  Â  const yPos = y - 40; // ãƒœã‚¹ã®é ­ä¸Šã‚ˆã‚Šå°‘ã—ä¸Š

Â  Â  ctx.textAlign = 'center';
Â  Â  ctx.fillStyle = '#ffcc00';
Â  Â  ctx.font = '12px monospace';
Â  Â Â 
Â  Â  // å¤–ç¸ã‚’é»’ã§æç”»ã—ã€è¦–èªæ€§ã‚’å‘ä¸Š
Â  Â  ctx.strokeStyle = '#000';
Â  Â  ctx.lineWidth = 2;
Â  Â  ctx.strokeText(name, x, yPos);
Â  Â  ctx.fillText(name, x, yPos);
}


// ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æ¼”å‡ºæç”»
function drawClear(){
Â  Â  // ç”»é¢å…¨ä½“ã‚’è¦†ã†ç™½ã„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
Â  Â  ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0, 1 - t/20)})`;
Â  Â  ctx.fillRect(0, 0, G.W, G.H);
Â  Â Â 
Â  Â  ctx.textAlign = 'center';
Â  Â  ctx.fillStyle = '#111827';
Â  Â  ctx.font = '24px monospace';
Â  Â  ctx.fillText('STAGE CLEAR!', G.W/2, G.H/2 - 10);

Â  Â  ctx.font = '16px monospace';
Â  Â  ctx.fillText(`SCORE: ${score}`, G.W/2, G.H/2 + 20);
}

// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆæ¼”å‡ºæç”»
function drawTransition(){
Â  Â  const nextName = STAGES[nextStageIndex].name;
Â  Â  const duration = 90; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
Â  Â  const phase = t / duration; // 0.0 -> 1.0

Â  Â  // é»’ã„å¸¯ãŒä¸­å¤®ã«é›†ã¾ã‚‹ã€ã¾ãŸã¯åºƒãŒã‚‹æ¼”å‡º
Â  Â  let coverHeight = G.H * 0.6;
Â  Â  let coverY = G.H / 2 - coverHeight / 2;
Â  Â Â 
Â  Â  // æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚º (0-40ãƒ•ãƒ¬ãƒ¼ãƒ ): ç”»é¢å…¨ä½“ã‚’è¦†ã†
Â  Â  // 2ç•ªç›®ã®ãƒ•ã‚§ãƒ¼ã‚º (40-90ãƒ•ãƒ¬ãƒ¼ãƒ ): ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤ºã—ã€ç”»é¢å¤–ã«åºƒãŒã‚‹
Â  Â Â 
Â  Â  if (phase < 0.4) {
Â  Â  Â  Â  // å¸¯ãŒåºƒãŒã‚‹ãƒ•ã‚§ãƒ¼ã‚º (ç”»é¢ã‚’è¦†ã„éš ã™)
Â  Â  Â  Â  coverY = G.H / 2 - (coverHeight * phase / 0.4) / 2;
Â  Â  Â  Â  coverHeight = coverHeight * phase / 0.4;
Â  Â  } else {
Â  Â  Â  Â  // å¸¯ãŒç”»é¢å¤–ã¸åºƒãŒã‚‹ãƒ•ã‚§ãƒ¼ã‚º
Â  Â  Â  Â  const reversePhase = (phase - 0.4) / 0.6; // 0.0 -> 1.0
Â  Â  Â  Â  coverY = G.H / 2 - coverHeight / 2 - (G.H * 0.5 * reversePhase);
Â  Â  Â  Â  coverHeight = G.H + (G.H * reversePhase);
Â  Â  }

Â  Â  ctx.fillStyle = '#111827';
Â  Â  ctx.fillRect(0, coverY, G.W, coverHeight);

Â  Â  if (phase > 0.1 && phase < 0.8) {
Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  ctx.fillStyle = '#e6f0ff';
Â  Â  Â  Â  ctx.font = '20px monospace';
Â  Â  Â  Â  ctx.fillText(`STAGE ${nextStageIndex + 1}: ${nextName}`, G.W/2, G.H/2 + 6);
Â  Â  }
}

// ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ†ãƒ¼ãƒã‚¿ã‚¤ãƒˆãƒ«æç”»ãƒ­ã‚¸ãƒƒã‚¯
function drawTitle(){
Â  Â  const stageNum = stageIndex + 1;
Â  Â  const stageName = currentStage.name;
Â  Â  const stageTheme = currentStage.theme; // æ–°ã—ã„ãƒ†ãƒ¼ãƒãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
Â  Â Â 
Â  Â  ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
Â  Â  ctx.fillRect(0, 0, G.W, G.H);

Â  Â  ctx.textAlign = 'center';
Â  Â  ctx.fillStyle = '#e6f0ff';
Â  Â Â 
Â  Â  // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆæ¼”å‡º
Â  Â  const duration = 120;
Â  Â  const alpha = Math.sin(Math.min(1, t / duration) * Math.PI);
Â  Â  ctx.globalAlpha = alpha;

Â  Â  ctx.font = '24px monospace';
Â  Â  ctx.fillText(`STAGE ${stageNum}: ${stageName}`, G.W / 2, G.H / 2 - 25);
Â  Â Â 
Â  Â  ctx.font = '16px monospace';
Â  Â  ctx.fillText(`THEME: ${stageTheme}`, G.W / 2, G.H / 2 + 15);

Â  Â  ctx.globalAlpha = 1; // å…ƒã«æˆ»ã™
}

// æ•µåã‚¿ã‚°ã®æç”»é–¢æ•° (çœç•¥)
function drawNameTag(d){
Â  Â  let name = d.type;
Â  Â  if (name === 'Company') name = 'ä¼šç¤¾';
Â  Â  else if (name === 'Meeting') name = 'æ‰“åˆã›';
Â  Â  else if (name === 'Celery') name = 'ã‚»ãƒ­ãƒª';
Â  Â  else if (name === 'Anxiety') name = 'ä¸å®‰';
Â  Â  else if (name === 'Tax') name = 'ç¨é‡‘';
Â  Â  else if (name === 'Work') name = 'ä»•äº‹';
Â  Â  else if (name === 'Insect' || name === 'DiveInsect') name = 'æ˜†è™«';

Â  Â  const yOffset = (d.type === 'Tax') ? 40 : 30;Â 
Â  Â  const yPos = d.y - yOffset;
Â  Â Â 
Â  Â  ctx.textAlign = 'center';
Â  Â  ctx.fillStyle = '#fff';
Â  Â  ctx.font = '10px monospace';
Â  Â Â 
Â  Â  ctx.strokeStyle = '#000';
Â  Â  ctx.lineWidth = 2;
Â  Â  ctx.strokeText(name, d.x, yPos);
Â  Â  ctx.fillText(name, d.x, yPos);
}


// ====================================
//Â  LOGIC
// ====================================
function initGame(){ // çœç•¥
Â  state = 'START';
Â  score = 0;
Â  lives = 10;Â 
Â  stageIndex = 0;
Â Â 
Â  startEl.style.display = 'flex';
Â  overEl.style.display = 'none';
}

function loadStage(idx){ // ã‚¹ãƒ†ãƒ¼ã‚¸é–‹å§‹æ™‚ã®åˆæœŸåŒ–
Â  stageIndex = idx;
Â  currentStage = STAGES[stageIndex];
Â  items.length = 0;
Â  obstacles.length = 0;
Â  bossShots.length = 0;
Â  bullets.length = 0;
Â Â 
Â  player.x = 80;
Â  player.y = G.GROUND;
Â  player.vy = 0;
Â  player.speed = currentStage.speed;
Â  player.bg = 0;
Â  workSpawn = 0;Â 
Â Â 
Â  stEl.textContent = currentStage.name;
Â  tgEl.textContent = isFinite(currentStage.target) ? currentStage.target : '----';
Â 
Â  // â˜… ã‚¹ãƒ†ãƒ¼ã‚¸é–‹å§‹æ™‚ã¯TITLEçŠ¶æ…‹ã«ç§»è¡Œ
Â  state = 'TITLE';Â 
Â  t = 0; // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ

Â  if(currentStage.boss){
    lives = MAX_LIVES;
    boss.active = true;
    boss.hp = BOSS_MAX_HP;
    boss.timer = 0;
    boss.x = G.W - 60;
    boss.attackIndex = 0;
    boss.attackTimer = 360;
    boss.isCharging = false;
    boss.beamWidth = 0;
    boss.frame = 0;
  } else {
    boss.active = false;
    boss.hp = BOSS_MAX_HP;
    boss.attackTimer = 360;
    boss.attackIndex = 0;
    boss.isCharging = false;
    boss.beamWidth = 0;
    boss.frame = 0;
  }
stopBgm();
  updateBgmSequencer();
}

function startGame(){Â 
Â  // â˜… ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
Â  if(state === 'START' || state === 'OVER'){
Â  Â  // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
Â  Â  score = 0;
Â  Â  lives = MAX_LIVES;
Â  Â Â 
Â  Â  // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ (loadStageå†…ã§stateã¯TITLEã«å¤‰ã‚ã‚‹)
Â  Â  loadStage(0);Â 
Â  Â Â 
Â  Â  startEl.style.display = 'none';
Â  Â  overEl.style.display = 'none';
Â  Â  beep(660,0.1,'square',0.2);
Â  }
}

function bossAttack(){ /* çœç•¥ */
  boss.attackTimer--;
  const attackType = BOSS_ATTACKS[boss.attackIndex];
  const bx = boss.x - 20;
  const by = boss.y - 20;

  // --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ ---
  // attackTimerã¯360ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã•ã‚Œã¾ã™
  if (boss.attackTimer > 100) {
    boss.frame = 1; // 100ãƒ•ãƒ¬ãƒ¼ãƒ ä»¥ä¸Šã‚ã‚‹ã¨ãã¯ã€Œã‚¿ãƒ¡ã€ãƒãƒ¼ã‚º
  } else if (boss.attackTimer > 20) {
    boss.frame = 2; // 20ã€œ100ã®é–“ã¯ã€Œç™ºå°„ï¼ˆæ”»æ’ƒä¸­ï¼‰ã€ãƒãƒ¼ã‚º
  } else {
    boss.frame = 0; // 20ä»¥ä¸‹ã¯ã€Œé€šå¸¸ï¼ˆæˆ»ã‚Šï¼‰ã€ãƒãƒ¼ã‚º
  }

  // â˜… æ”»æ’ƒã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã®åŸºæº–å€¤ã‚’å¢—ã‚„ã™ (360)
  if(boss.attackTimer <= 0){
    boss.attackIndex = (boss.attackIndex + 1) % BOSS_ATTACKS.length;
    boss.attackTimer = 360; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å¢—åŠ 
    boss.isCharging = false;
    boss.beamWidth = 0;
    boss.frame = 0; // æ¬¡ã®æ”»æ’ƒã«å‘ã‘ã¦ãƒªã‚»ãƒƒãƒˆ
    return;
  }
Â Â 
Â  // æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ 1: MoaiThrow_Arc (æ”¾ç‰©ç·šæŠ•ã’)
Â  if(attackType === 'MoaiThrow_Arc' && boss.attackTimer % 80 === 0 && boss.attackTimer > 160){
Â  Â  const targetX = player.x;
Â  Â  const targetY = player.y - 15;
Â  Â  const angleToTarget = Math.atan2(targetY - by, targetX - bx);
Â  Â  const randomOffset = (Math.random() - 0.5) * 0.6;Â 
Â  Â  const initialAngle = angleToTarget + randomOffset;
Â  Â  const initialSpeed = 8 + (Math.random() * 4);Â 

Â  Â  const vx = Math.cos(initialAngle) * initialSpeed;
Â  Â  const vy = Math.sin(initialAngle) * initialSpeed;

Â  Â  bossShots.push({x:bx, y:by, vx:vx, vy:vy, type:attackType, gravity:0.2});Â 
Â  Â  beep(150,0.1,'sawtooth',0.1);
Â  }

Â  // æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ 2: MoaiThrow_Horizontal (æ°´å¹³é€£å°„)
Â  if(attackType === 'MoaiThrow_Horizontal'){
Â  Â  const shootY = boss.y + Math.sin(t*0.1) * 10;Â 
Â  Â  const speed = 4.0;
Â  Â Â 
Â  Â  if(boss.attackTimer > 60 && boss.attackTimer % 30 === 0){ // é€£å°„é–“éš”ã‚’30ãƒ•ãƒ¬ãƒ¼ãƒ ã«å»¶é•·
Â  Â  Â  Â  const angle = Math.atan2(player.y - shootY, player.x - bx);
Â  Â  Â  Â  const vx = Math.cos(angle) * speed;
Â  Â  Â  Â  const vy = Math.sin(angle) * speed * 0.2;Â 
Â  Â  Â  Â  bossShots.push({x:bx, y:shootY, vx:vx, vy:vy, type:attackType, gravity:0});
Â  Â  Â  Â  beep(800, 0.03, 'sine', 0.1);
Â  Â  }

Â  Â  if (boss.attackTimer === 300) boss.isCharging = true;Â 
Â  Â  if (boss.attackTimer === 250) boss.isCharging = false;
Â  Â  if (boss.attackTimer === 50) boss.attackTimer = 0;
Â  }

Â  // æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ 3: MoaiThrow_Homing (èª˜å°æŠ•ã’)
Â  // â˜… èª˜å°å¼¾ã¯æ”»æ’ƒãƒ•ã‚§ãƒ¼ã‚ºä¸­ã€1å›ã ã‘ç™ºå°„
Â  if(attackType === 'MoaiThrow_Homing' && boss.attackTimer === 240){Â 
Â  Â  const dx = player.x - bx;
Â  Â  const dy = player.y - by;
Â  Â  const angle = Math.atan2(dy, dx);
Â  Â  const speed = 2.5;
Â  Â Â 
Â  Â  // â˜… èª˜å°å¼¾ã«å¯¿å‘½ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆ (300ãƒ•ãƒ¬ãƒ¼ãƒ  = 5ç§’)
Â  Â  bossShots.push({x:bx, y:by, vx:Math.cos(angle)*speed, vy:Math.sin(angle)*speed, type:attackType, homingTarget:player, lifetime: 300});
Â  Â  beep(200,0.08,'triangle',0.15);
Â  }
}


function updatePlay(){
Â  t++;
Â  player.bg += player.speed;
Â  player.bob += 0.2;

Â  player.vy += 0.44;
Â  player.y += player.vy;
Â  if(player.y >= G.GROUND){
Â  Â  player.y = G.GROUND;
Â  Â  player.vy = 0;
Â  Â  player.onG = true;
Â  }

Â  const isBoss = currentStage.boss && boss.active;

Â  if(!isBoss){
Â  Â  // ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒãƒ¼ãƒ³ (çœç•¥)
Â  Â  if(--itemSpawn <= 0){
Â  Â  Â  const isStrawberry = Math.random() < 0.15;
Â  Â  Â  const scoreValue = isStrawberry ? 20 : 10;
Â  Â  Â  const isHeal = Math.random() < 0.05;
Â  Â  Â  items.push({ x:G.W+20, y:G.GROUND-10-Math.random()*40, taken:false, heal:isHeal, score:scoreValue });
Â  Â  Â  itemSpawn = (30/player.speed * currentStage.obsRate)|0 + Math.random()*20;
Â  Â  }
Â  Â Â 
Â  Â  // 1. é€šå¸¸ã®æ•µã‚¹ãƒãƒ¼ãƒ³ (Workã‚’é™¤ã)
Â  Â  if(--obstacleSpawn <= 0){
Â  Â  Â  Â  const r = Math.random();
Â  Â  Â  Â  let spawnRateSum = 0;
Â  Â  Â  Â  let type = null;
Â  Â  Â  Â 
Â  Â  Â  Â  // Tax, Insect, Company, Meeting, Celery, Anxietyã®æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ (çœç•¥)
Â  Â  Â  Â  spawnRateSum += currentStage.taxRate;
Â  Â  Â  Â  if(r < spawnRateSum){ type = 'Tax'; }Â 
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  spawnRateSum += currentStage.insectRate;
Â  Â  Â  Â  Â  Â  if(r < spawnRateSum){ type = (Math.random() < 0.7) ? 'Insect' : 'DiveInsect'; }Â 
Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  spawnRateSum += currentStage.companyRate;
Â  Â  Â  Â  Â  Â  Â  Â  if(r < spawnRateSum){ type = 'Company'; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  spawnRateSum += currentStage.meetingRate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(r < spawnRateSum){ type = 'Meeting'; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  spawnRateSum += currentStage.celeryRate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(r < spawnRateSum){ type = 'Celery'; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  spawnRateSum += currentStage.anxietyRate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(r < spawnRateSum){ type = 'Anxiety'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(type){
Â  Â  Â  Â  Â  Â  let newObstacle = { x:G.W+20, type:type, hit:false, vy:0 };
Â  Â  Â  Â  Â  Â  // æ•µã®åˆæœŸYåº§æ¨™è¨­å®šï¼ˆWorkã‚’é™¤ãï¼‰
Â  Â  Â  Â  Â  Â  if(type === 'Insect' || type === 'DiveInsect'){
Â  Â  Â  Â  Â  Â  Â  Â  newObstacle.y = (type === 'Insect') ? G.GROUND-(Math.random()<0.6?20:50) : 0;
Â  Â  Â  Â  Â  Â  } else if(type === 'Tax'){
Â  Â  Â  Â  Â  Â  Â  Â  newObstacle.y = G.GROUND - 15;
Â  Â  Â  Â  Â  Â  } else if(type === 'Anxiety'){
Â  Â  Â  Â  Â  Â  Â  Â  newObstacle.y = G.GROUND-50;
Â  Â  Â  Â  Â  Â  Â  Â  newObstacle.startY = G.GROUND-50;
Â  Â  Â  Â  Â  Â  Â  Â  newObstacle.amplitude = 30;
Â  Â  Â  Â  Â  Â  Â  Â  newObstacle.phase = Math.random()*6.28;
Â  Â  Â  Â  Â  Â  } else { // Company, Meeting, Celery (åœ°ä¸Šå›ºå®š)
Â  Â  Â  Â  Â  Â  Â  Â  newObstacle.y = G.GROUND;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  obstacles.push(newObstacle);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  obstacleSpawn = (90/player.speed * currentStage.obsRate)|0 + Math.random()*50;
Â  Â  }

Â  Â  // 2. ä»•äº‹ (Work) å°‚ç”¨ã‚¹ãƒãƒ¼ãƒ³ãƒ­ã‚¸ãƒƒã‚¯Â 
Â  Â  if(currentStage.workRate > 0 && --workSpawn <= 0){
Â  Â  Â  Â  const min = currentStage.workSpawnMin;
Â  Â  Â  Â  const max = currentStage.workSpawnMax;
Â  Â  Â  Â  workSpawn = min + Math.random() * (max - min);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (Math.random() < currentStage.workRate) {
Â  Â  Â  Â  Â  Â  let workObstacle = { x:G.W+20, type:'Work', hit:false, vy:0 };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (Math.random() < 0.7) {
Â  Â  Â  Â  Â  Â  Â  Â  workObstacle.y = G.GROUND;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  workObstacle.y = 0;
Â  Â  Â  Â  Â  Â  Â  Â  workObstacle.isFallingWork = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  obstacles.push(workObstacle);
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€Ÿåº¦ä¸Šæ˜‡ã®é »åº¦ã‚’ç·©å’Œ (1200ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨)
Â  Â  if(t%1200===0) player.speed = Math.min(player.speed+0.1, 4.0);
Â  } else {
Â  Â  // Boss Logic (PLAYçŠ¶æ…‹ã§ã®ã¿å®Ÿè¡Œ)
Â  Â  bossAttack();
Â  Â Â 
Â  Â  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼¾ä¸¸ã¨ãƒœã‚¹ã®å½“ãŸã‚Šåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
Â  Â  for(let i=bullets.length-1;i>=0;i--){
Â  Â  Â  Â  const b=bullets[i];
Â  Â  Â  Â  // ãƒœã‚¹ã¨ã®è¡çªåˆ¤å®š
Â  Â  Â  Â  if(Math.abs(b.x-boss.x)<28 && Math.abs(b.y-boss.y)<30){Â 
Â  Â  Â  Â  Â  Â  boss.hp -= 4; // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹
Â  Â  Â  Â  Â  Â  bullets.splice(i,1); // å¼¾ä¸¸ã‚’å‰Šé™¤
Â  Â  Â  Â  Â  Â  beep(800,0.05,'square',0.1);
Â  Â  Â  Â  Â  Â  if(boss.hp <= 0){
Â  Â  Â  Â  Â  Â  Â  Â  state = 'ENDING';
Â  Â  Â  Â  Â  Â  Â  Â  endScrollY = G.H;
Â  Â  Â  Â  Â  Â  Â  Â  playFanfare();Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  }

Â  // Move & Collide (çœç•¥)
Â  items.forEach(it => it.x -= player.speed);
Â  for(let i=items.length-1;i>=0;i--){
Â  Â  const it=items[i];
Â  Â  if(!it.taken && Math.abs(it.x-player.x)<14 && Math.abs(it.y-player.y+10)<18){
Â  Â  Â  it.taken = true;
Â  Â  Â  score += it.score;Â 
Â  Â  Â  if(it.heal) { lives = Math.min(lives+1, MAX_LIVES); beep(1200,0.1,'sine',0.3); }
Â  Â  Â  else beep(880,0.08,'triangle',0.2);
Â  Â  }
Â  Â  if(it.x < -20 || it.taken) items.splice(i,1);
Â  }

Â  // Obstacles
Â  for(let i=obstacles.length-1;i>=0;i--){
Â  Â  const d=obstacles[i];
Â  Â  d.x -= player.speed*1.2;
Â  Â Â 
Â  Â  // æ•µã®æŒ™å‹•ã‚’æ–°ã—ã„ã‚¿ã‚¤ãƒ—åã§å†é©ç”¨
Â  Â  if(d.type === 'Insect'){ // æ˜†è™« (Drone)
Â  Â  Â  if(d.y<G.GROUND) d.y += Math.sin(t*0.1)*0.5;
Â  Â  } else if(d.type === 'DiveInsect'){ // çªé€²æ˜†è™« (DiveDrone)
Â  Â  Â  if(d.y < G.GROUND - 20) d.vy += 0.3;
Â  Â  Â  else d.vy = 0;
Â  Â  Â  d.y += d.vy;
Â  Â  } else if(d.type === 'Anxiety'){ // å°†æ¥ã®ä¸å®‰ (Mine)
Â  Â  Â  d.y = d.startY + Math.sin(t*0.1 + d.phase) * d.amplitude;
Â  Â  } else if(d.type === 'Tax'){ // ç¨é‡‘ (Slime)
Â  Â  Â  Â  d.y = G.GROUND - 15;Â 
Â  Â  } else if(d.type === 'Company' || d.type === 'Meeting' || d.type === 'Celery' || d.type === 'Work'){ // åœ°ä¸Šå›ºå®š
Â  Â  Â  Â  if (d.type !== 'Work' || !d.isFallingWork) {
Â  Â  Â  Â  Â  d.y = G.GROUND;Â 
Â  Â  Â  Â  }
Â  Â  } else if(d.type === 'Work' && d.isFallingWork){ // ä»•äº‹ (è½ä¸‹ä¸­)
Â  Â  Â  Â  if(d.y < G.GROUND) d.vy += 0.4;
Â  Â  Â  Â  else d.vy = 0;
Â  Â  Â  Â  d.y += d.vy;
Â  Â  }

Â  Â  // å½“ãŸã‚Šåˆ¤å®š
Â  Â  if(!d.hit){
Â  Â  Â  let hit = false;
Â  Â  Â  let collisionRadius = 12;Â 
Â  Â  Â  let collisionOffsetY = 16;Â 
Â  Â  Â Â 
Â  Â  Â  if(d.type === 'Tax'){ // ç¨é‡‘ (Slime)
Â  Â  Â  Â  Â  collisionRadius = 20;Â 
Â  Â  Â  Â  Â  collisionOffsetY = 24;Â 
Â  Â  Â  } else if(d.type === 'Insect' || d.type === 'DiveInsect'){ // æ˜†è™« (Drone)
Â  Â  Â  Â  Â  collisionRadius = 14;Â 
Â  Â  Â  Â  Â  collisionOffsetY = 12;Â 
Â  Â  Â  } else if(d.type === 'Company'){ // ä¼šç¤¾ (Spike) - åœ°ä¸Šåˆ¤å®š
Â  Â  Â  Â  Â  if(player.onG && Math.abs(d.x-player.x)<14){ hit=true; }
Â  Â  Â  } else if(d.type === 'Meeting' || d.type === 'Work'){ // æ‰“ã¡åˆã‚ã›/ä»•äº‹ - åœ°ä¸Šå›ºå®š
Â  Â  Â  Â  Â  collisionRadius = 20;Â 
Â  Â  Â  Â  Â  collisionOffsetY = 16;
Â  Â  Â  } else if(d.type === 'Celery'){ // ç”Ÿã‚»ãƒ­ãƒª - åœ°ä¸Šå›ºå®šÂ 
Â  Â  Â  Â  Â  collisionRadius = 20; // ä¿®æ­£æ¸ˆã¿
Â  Â  Â  Â  Â  collisionOffsetY = 16;
Â  Â  Â  } else if(d.type === 'Anxiety'){ // å°†æ¥ã®ä¸å®‰ (Mine)
Â  Â  Â  Â  Â  collisionRadius = 14;Â 
Â  Â  Â  Â  Â  collisionOffsetY = 16;
Â  Â  Â  }

Â  Â  Â  // åœ°ä¸Šå›ºå®šï¼ˆCompanyã®ã¿ç‰¹æ®Šåˆ¤å®šã€ãã®ä»–ã¯å††å½¢åˆ¤å®šï¼‰
Â  Â  Â  if(d.type !== 'Company' && !hit){
Â  Â  Â  Â  if(Math.abs(d.x-player.x)<collisionRadius && Math.abs(d.y-player.y+collisionOffsetY)<collisionRadius){ hit=true; }
Â  Â  Â  }

Â  Â  Â  if(hit){
Â  Â  Â  Â  d.hit = true;
Â  Â  Â  Â  lives--;
Â  Â  Â  Â  beep(100,0.2,'sawtooth',0.3);
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if(d.x < -20 || d.hit) obstacles.splice(i,1);
Â  }

Â  // Boss Shots (æ”»æ’ƒå¼¾ã®æŒ™å‹•ä¿®æ­£)
Â  for(let i=bossShots.length-1;i>=0;i--){
Â  Â  const s=bossShots[i];
Â  Â Â 
Â  Â  // â˜… èª˜å°å¼¾ã®å¯¿å‘½ãƒã‚§ãƒƒã‚¯
Â  Â  if (s.type === 'MoaiThrow_Homing') {
Â  Â  Â  Â  s.lifetime--;
Â  Â  Â  Â  if (s.lifetime <= 0) {
Â  Â  Â  Â  Â  Â  bossShots.splice(i, 1);
Â  Â  Â  Â  Â  Â  continue;Â 
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if(s.type === 'MoaiThrow_Arc') { // æ”¾ç‰©ç·šæŠ•ã’
Â  Â  Â  s.vy += s.gravity;Â 
Â  Â  }
Â  Â  else if(s.type === 'MoaiThrow_Homing'){ // è¿½å°¾æŠ•ã’
Â  Â  Â  Â  const targetX = player.x;
Â  Â  Â  Â  const targetY = player.y - 15;
Â  Â  Â  Â  const dx = targetX - s.x;
Â  Â  Â  Â  const dy = targetY - s.y;
Â  Â  Â  Â  const angle = Math.atan2(dy, dx);
Â  Â  Â  Â  const currentSpeed = Math.sqrt(s.vx*s.vx + s.vy*s.vy);
Â  Â  Â  Â  const homingFactor = 0.05;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const MAX_TURN_RATE = 0.05;Â 
Â  Â  Â  Â  let currentAngle = Math.atan2(s.vy, s.vx);
Â  Â  Â  Â  let angleDiff = angle - currentAngle;

Â  Â  Â  Â  if (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
Â  Â  Â  Â  if (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;

Â  Â  Â  Â  if (angleDiff > MAX_TURN_RATE) angleDiff = MAX_TURN_RATE;
Â  Â  Â  Â  else if (angleDiff < -MAX_TURN_RATE) angleDiff = -MAX_TURN_RATE;

Â  Â  Â  Â  let newAngle = currentAngle + angleDiff;
Â  Â  Â  Â  const MAX_SPEED = 5.0;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  s.vx = Math.cos(newAngle) * currentSpeed;
Â  Â  Â  Â  s.vy = Math.sin(newAngle) * currentSpeed;

Â  Â  Â  Â  const mag = Math.sqrt(s.vx*s.vx + s.vy*s.vy);
Â  Â  Â  Â  if(mag > MAX_SPEED) {
Â  Â  Â  Â  Â  Â  s.vx = (s.vx/mag) * MAX_SPEED;
Â  Â  Â  Â  Â  Â  s.vy = (s.vy/mag) * MAX_SPEED;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  s.x += s.vx;
Â  Â  s.y += s.vy;
Â  Â Â 
Â  Â  if(Math.abs(s.x-player.x)<10 && Math.abs(s.y-player.y+16)<16){
Â  Â  Â  lives--;
Â  Â  Â  bossShots.splice(i,1);
Â  Â  Â  beep(100,0.2,'sawtooth',0.3);
Â  Â  }
Â  Â  // èª˜å°å¼¾ (MoaiThrow_Homing) å°‚ç”¨ã®ç”»é¢å¤–å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯
Â  Â  else if(s.type === 'MoaiThrow_Homing' && (s.x < player.x - 100 || s.y > G.H + 50 || s.y < -50)) {
Â  Â  Â  Â  bossShots.splice(i, 1);
Â  Â  }
Â  Â  else if(s.x < -20 || s.y > G.H+20) bossShots.splice(i,1);
Â  }

Â  // Player Bullets (ãƒœã‚¹æˆ¦ã§ã®æ”»æ’ƒã«ä½¿ç”¨)
Â  for(let i=bullets.length-1;i>=0;i--){
Â  Â  bullets[i].x += 5;
Â  Â  if(bullets[i].x > G.W) bullets.splice(i,1);
Â  }

Â  // Stage Clear Check (æ¼”å‡ºè¿½åŠ )
Â  if(!isBoss && score >= currentStage.target){
Â  Â  if(stageIndex < STAGES.length-1){
Â  Â  Â  Â  nextStageIndex = stageIndex + 1; // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¨˜éŒ²
Â  Â  Â  Â  state = 'CLEAR'; // â˜… CLEARçŠ¶æ…‹ã«ç§»è¡Œ
Â  Â  Â  Â  t = 0; // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ¼”å‡ºæ™‚é–“ã‚’è¨ˆæ¸¬
Â  Â  Â  Â  playFanfare();
Â  Â  Â  Â  return;
Â  Â  }
Â  }

Â  // Game Over (çœç•¥)
Â  if(lives <= 0){
Â  Â  state = 'OVER';
Â  Â  best = Math.max(best, score);
Â  Â  document.getElementById('overTitle').textContent = 'GAME OVER';
Â  Â  document.getElementById('scoreline').textContent = `SCORE: ${score} / BEST: ${best}`;
Â  Â  overEl.style.display = 'flex';
    stopBgm();
Â  }

Â  // Update UI (çœç•¥)
Â  scEl.textContent = score;
Â  lfEl.textContent = lives;
}

// ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢å¾Œã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
function updateClear(){
Â  Â  t++;
Â  Â  if(t > 60){ // 1ç§’é–“ã®ã‚¯ãƒªã‚¢è¡¨ç¤ºå¾Œã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã«ç§»è¡Œ
Â  Â  Â  Â  state = 'TRANSITION';
Â  Â  Â  Â  t = 0;
Â  Â  }
}

// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
function updateTransition(){
Â  Â  t++;
Â  Â  if(t > 90){ // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã€æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰
Â  Â  Â  Â  loadStage(nextStageIndex); // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰ (ã“ã®ä¸­ã§stateãŒTITLEã«å¤‰ã‚ã‚‹)
Â  Â  Â  Â  t = 0;
Â  Â  }
}

// ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
function updateTitle(){
Â  Â  t++;
Â  Â  if(t > 120){ // 2ç§’ (120ãƒ•ãƒ¬ãƒ¼ãƒ ) è¡¨ç¤º
Â  Â  Â  Â  state = 'PLAY';
Â  Â  Â  Â  t = 0;
Â  Â  }
}

// â˜… ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«ã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ (ç§˜å¯†ã®ã‚³ãƒ¼ãƒ‰åœæ­¢å‡¦ç†ã‚’ä¿®æ­£)
function updateEnding(){
Â  Â  const textHeight = 20;
Â  Â  // ç§˜å¯†ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãŒç”»é¢ä¸­å¤®ã«é”ã™ã‚‹ç›®æ¨™ä½ç½®ã‚’è¨ˆç®—
Â  Â  const targetY = G.H / 2 - textHeight * 1.5;Â 
Â  Â  // ç§˜å¯†ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ç¾åœ¨ã®å…ˆé ­è¡Œã®Yåº§æ¨™
Â  Â  const currentCodeBlockY = endScrollY + SECRET_CODE_START_INDEX * textHeight;

Â  Â  // ç§˜å¯†ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãŒä¸­å¤®ã«åˆ°é”ã—ãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åœæ­¢
Â  Â  if (currentCodeBlockY < targetY && endScrollY > -1000) {Â 
Â  Â  Â  Â  endScrollY -= 0.6; // é€šå¸¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦
Â  Â  } else if (currentCodeBlockY >= targetY && t < SECRET_CODE_DURATION) {
Â  Â  Â  Â  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢ï¼†æ¼”å‡ºä¸­
Â  Â  Â  Â  t++;
Â  Â  } else {
Â  Â  Â  Â  // æ¼”å‡ºçµ‚äº†å¾Œã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å†é–‹
Â  Â  Â  Â  endScrollY -= 0.6;
Â  Â  Â  Â  t++;

Â  Â  Â  Â  // ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«çµ‚äº†ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  if (endScrollY < - (CREDITS.length * textHeight + 100)){
Â  Â  Â  Â  Â  Â  state = 'OVER';
Â  Â  Â  Â  Â  Â  best = Math.max(best, score);
Â  Â  Â  Â  Â  Â  document.getElementById('overTitle').textContent = 'YOU WIN!';
Â  Â  Â  Â  Â  Â  document.getElementById('scoreline').textContent = `FINAL SCORE: ${score}`;
Â  Â  Â  Â  Â  Â  document.getElementById('retry').textContent = 'PLAY AGAIN';
Â  Â  Â  Â  Â  Â  overEl.style.display = 'flex';
            stopBgm();
Â  Â  Â  Â  }
Â  Â  }
}


// ====================================
//Â  MAIN LOOP
// ====================================
function loop(){
Â  ctx.clearRect(0,0,G.W,G.H);
Â Â 
Â  if(state === 'PLAY' || state === 'CLEAR' || state === 'TRANSITION' || state === 'TITLE' || state === 'ENDING'){
Â  Â  // èƒŒæ™¯ã¨æ•µã¯å¸¸ã«æç”»ï¼ˆCLEAR, TITLE, TRANSITIONçŠ¶æ…‹ã¯æ™‚é–“ãŒåœæ­¢ï¼‰
Â  Â  drawSky();
Â  Â  drawGround();
Â  Â  items.forEach(drawBottle);
Â  Â Â 
Â  Â  obstacles.forEach(d=>{
Â  Â  Â  Â  if(d.type === 'Insect' || d.type === 'DiveInsect') drawInsect(d);Â 
Â  Â  Â  Â  else if(d.type === 'Tax') drawTax(d);Â 
Â  Â  Â  Â  else if(d.type === 'Company') drawCompany(d);Â 
Â  Â  Â  Â  else if(d.type === 'Meeting') drawMeeting(d);Â 
Â  Â  Â  Â  else if(d.type === 'Celery') drawCelery(d);Â 
Â  Â  Â  Â  else if(d.type === 'Anxiety') drawAnxiety(d);Â 
Â  Â  Â  Â  else if(d.type === 'Work') drawWork(d);Â 
Â  Â  });

Â  Â  drawMoai();
Â  Â Â 
Â  Â  ctx.fillStyle='#e5f0ff';
Â  Â  bullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x,b.y,3,0,6.28); ctx.fill(); });
Â  Â Â 
Â  Â  if(currentStage.boss && boss.active) {
Â  Â  Â  drawBoss();
Â  Â  Â  bossShots.forEach(drawMoaiShot);Â 
Â  Â  }
Â  Â Â 
Â  Â  // â˜… æ•µåã‚¿ã‚°ã®æç”»
Â  Â  if (state === 'PLAY' || state === 'CLEAR' || state === 'TITLE') {Â 
Â  Â  Â  Â  obstacles.forEach(drawNameTag);
Â  Â  }
Â  Â Â 
Â  Â  // â˜… ãƒœã‚¹åã‚¿ã‚°ã®æç”»
Â  Â  if (state === 'PLAY' && currentStage.boss && boss.active) {
Â  Â  Â  Â  drawBossNameTag();
Â  Â  }


Â  Â  // â˜… çŠ¶æ…‹ã”ã¨ã®æ›´æ–°ã¨æç”»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
Â  Â  if(state === 'PLAY') updatePlay();
Â  Â  else if(state === 'CLEAR'){
Â  Â  Â  Â  drawClear();
Â  Â  Â  Â  updateClear();
Â  Â  }
Â  Â  else if(state === 'TRANSITION'){
Â  Â  Â  Â  drawTransition();
Â  Â  Â  Â  updateTransition();
Â  Â  }
Â  Â  else if(state === 'TITLE'){
Â  Â  Â  Â  drawTitle();
Â  Â  Â  Â  updateTitle();
Â  Â  }
Â  Â  else if(state === 'ENDING') {
Â  Â  Â  ctx.fillStyle = 'rgba(0,0,0,0.7)';
Â  Â  Â  ctx.fillRect(0,0,G.W,G.H);
Â  Â  Â Â 
Â  Â  Â  // â˜… ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«æç”»ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
Â  Â  Â  ctx.font = '12px monospace';
Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â Â 
Â  Â  Â  const textHeight = 20;
Â  Â  Â  let currentScrollY = endScrollY;
Â  Â  Â Â 
Â  Â  Â  const codeSectionReached = endScrollY + SECRET_CODE_START_INDEX * textHeight <= (G.H / 2 - textHeight * 1.5);

Â  Â  Â  if (codeSectionReached && t < SECRET_CODE_DURATION) {
Â  Â  Â  Â  Â  // åœæ­¢ä¸­ã€‚ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«ã® y åº§æ¨™ã‚’å›ºå®š
Â  Â  Â  Â  Â  const targetY = G.H / 2 - textHeight * 1.5;Â 
Â  Â  Â  Â  Â  currentScrollY = targetY - SECRET_CODE_START_INDEX * textHeight;

Â  Â  Â  Â  Â  // é‡‘è‰²ã®ã‚ªãƒ¼ãƒ©ã‚’æç”» (t ã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)
Â  Â  Â  Â  Â  const flash = Math.sin(t * 0.1) * 0.1 + 0.1;Â 
Â  Â  Â  Â  Â  ctx.fillStyle = `rgba(255, 215, 0, ${flash})`;
Â  Â  Â  Â  Â  ctx.fillRect(0, 0, G.W, G.H);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  CREDITS.forEach((line, i)=>{
Â  Â  Â  Â  Â  let y = currentScrollY + i * textHeight;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (y > -textHeight && y < G.H + textHeight) { // ç”»é¢å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯

Â  Â  Â  Â  Â  Â  Â  // â˜…â˜…â˜… YOGURTLOVE ã®è¡Œ (Index 14) ã®ã¿å¼·èª¿ã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  Â  if (i === 14) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  const goldFlash = (Math.sin(t * 0.2) * 0.5) + 0.5;
Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆYOGURTLOVEå°‚ç”¨ï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = `rgba(255, 215, 0, ${goldFlash})`; // é‡‘è‰²ã«ç‚¹æ»…
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = '16px monospace';
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = `rgba(255, 215, 0, 0.5)`;
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã«æˆ»ã™
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#fff';
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = '12px monospace';
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  ctx.strokeText(line, G.W/2, y); // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³
Â  Â  Â  Â  Â  Â  Â  ctx.fillText(line, G.W/2, y);
Â  Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
Â  Â  Â  updateEnding();
Â  Â  }
Â  } else {
Â  Â  drawSky();
Â  Â  drawGround();
Â  }

Â  requestAnimationFrame(loop);
}

// ====================================
//Â  INPUTS (çœç•¥)
// ====================================
function jump(){
Â  if(state!=='PLAY') return;
Â  if(player.onG){
Â  Â  player.vy = -8.5;
Â  Â  player.onG = false;
Â  Â  beep(700,0.05,'square',0.1);
Â  }
}
function drop(){
Â  if(state!=='PLAY') return;
Â  if(!player.onG) player.vy += 2.5;
}
function shoot(){
Â  if(state!=='PLAY') return;
Â  // â˜… ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã®æ”»æ’ƒè¨±å¯ãƒ­ã‚¸ãƒƒã‚¯
Â  if(currentStage.boss && boss.active){
Â  Â  bullets.push({x:player.x+10, y:player.y-30});
Â  Â  beep(900,0.04,'square',0.1);
Â  }
}

document.getElementById('go').onclick = startGame;
document.getElementById('retry').onclick = initGame;

const jBtn = document.getElementById('jump');
const dBtn = document.getElementById('drop');
const sBtn = document.getElementById('shot');

jBtn.addEventListener('touchstart',e=>{e.preventDefault();jump()}, {passive:false});
dBtn.addEventListener('touchstart',e=>{e.preventDefault();drop()}, {passive:false});
sBtn.addEventListener('touchstart',e=>{e.preventDefault();shoot()}, {passive:false});

addEventListener('keydown', e=>{
Â  if(e.code==='Enter' && (state==='START'||state==='OVER')) {Â 
Â  Â  if(state==='OVER') initGame(); else startGame();Â 
Â  }
Â  if(e.code==='Space' || e.code==='ArrowUp') jump();
Â  if(e.code==='ArrowDown') drop();
Â  if(e.code==='KeyF') shoot();
});

// START
initGame();
updateMuteUI();
loop();

})();
</script>
</body>
</html>
